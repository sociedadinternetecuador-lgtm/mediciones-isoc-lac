<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mediciones ISOC LAC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 1rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    h1 { font-size: 1.6rem; margin: 0 0 0.25rem 0; color: #0f172a; }
    h2 { font-size: 1.1rem; margin: 0 0 0.75rem 0; color: #111827; }
    .subtitle { font-size: 0.85rem; color: #4b5563; margin-bottom: 0.25rem; }
    .note { font-size: 0.8rem; color: #2563eb; margin-bottom: 0.75rem; }
    .layout { display: flex; flex-direction: column; gap: 1rem; }
    @media (min-width: 900px) {
      .layout { flex-direction: row; align-items: flex-start; }
      .left-column { flex: 0 0 380px; }
      .right-column { flex: 1; }
    }
    .card {
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 1rem;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      border: 1px solid #e5e7eb;
    }
    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
      color: #374151;
    }
    input[type="text"] {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #111827;
      font-size: 0.9rem;
    }
    input[type="text"]::placeholder { color: #9ca3af; }
    input[type="file"] { display: none; }
    .file-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.35rem;
      flex-wrap: wrap;
    }
    .file-name {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .small { font-size: 0.8rem; color: #6b7280; }
    .buttons-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
      align-items: center;
    }
    button {
      padding: 0.45rem 0.9rem;
      border-radius: 9999px;
      border: none;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      white-space: nowrap;
    }
    button:disabled { opacity: 0.6; cursor: default; }
    .btn-primary { background: #2563eb; color: #ffffff; }
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #e5e7eb;
    }
    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    #status { margin-top: 0.35rem; min-height: 1.1em; }
    .log {
      margin-top: 0.5rem;
      max-height: 160px;
      overflow: auto;
      background: #f9fafb;
      border-radius: 0.5rem;
      padding: 0.5rem;
      font-size: 0.75rem;
      border: 1px solid #e5e7eb;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      display: none;
    }
    .preview {
      margin-top: 0.5rem;
      font-size: 0.78rem;
      color: #4b5563;
      background: #f9fafb;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      padding: 0.5rem;
      max-height: 120px;
      overflow: auto;
    }
    .progress-wrapper {
      margin-top: 0.4rem;
      display: none;
    }
    .progress-bar-bg {
      width: 100%;
      height: 6px;
      border-radius: 9999px;
      background: #e5e7eb;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: #2563eb;
      transition: width 0.15s linear;
    }
    .progress-text {
      margin-top: 0.2rem;
      font-size: 0.75rem;
      color: #4b5563;
    }
    .table-container {
      width: 100%;
      overflow-x: auto;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      min-width: 780px;
    }
    th, td {
      padding: 0.45rem 0.5rem;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    th {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #e5e7eb;
      color: #111827;
      font-weight: 600;
    }
    tr:nth-child(even) td { background: #f9fafb; }
    tr:nth-child(odd) td { background: #ffffff; }
    .ok { color: #15803d; font-weight: 600; }
    .bad { color: #b91c1c; font-weight: 600; }
    .warn { color: #92400e; font-weight: 600; }
    .actions-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .summary {
      margin-bottom: 0.5rem;
      display: none;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.5rem;
    }
    .summary-item {
      background: #f9fafb;
      border-radius: 0.5rem;
      padding: 0.4rem 0.6rem;
      border: 1px solid #e5e7eb;
      font-size: 0.78rem;
    }
    .summary-label {
      color: #6b7280;
      display: block;
    }
    .summary-value {
      font-weight: 600;
      color: #111827;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem 1rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .filters span {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .filters label {
      font-size: 0.78rem;
      margin-bottom: 0;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 1rem;
      max-width: 360px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.3);
      border: 1px solid #e5e7eb;
    }
    .modal-text {
      font-size: 0.9rem;
      color: #111827;
      margin-bottom: 0.75rem;
    }
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }
    .note-box {
      margin-top: 0.75rem;
      background: #eef2ff;
      border-left: 4px solid #4f46e5;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.8rem;
      color: #1e1b4b;
      display: none;
    }
    .contact-box {
      margin-top: 0.75rem;
      text-align: right;
    }

    .note-toggle-row {
      margin-top: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
  
    .lang-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.6rem;
      border-radius: 9999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 0.8rem;
      cursor: pointer;
      color: #374151;
    }
    .lang-toggle span.code {
      font-weight: 600;
    }
    .flag {
      font-size: 1rem;
      line-height: 1;
      display: inline-block;
    }
    .flag-ec,
    .flag-us {
      background-image: none !important;
    }
</style>
</head>
<body>
    <header style="margin-bottom: 0.75rem;">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:0.75rem;">
      <div>
        <h1 id="titleMain">Mediciones ISOC LAC</h1>
        <div class="subtitle" id="subtitleMain">Herramienta experimental para revisi√≥n r√°pida de dominios.</div>
        <div class="note" id="noteMain">
          V√°lido para cualquier dominio (incluidos dominios de 3er y 4to nivel).
        </div>
      </div>
      <button id="langToggle" type="button" class="lang-toggle" title="Cambiar idioma">
        <span id="langCode" class="code">ES</span>
        <span id="langFlag" class="flag flag-ec">üá™üá®</span>
      </button>
    </div>
  </header>

  <div class="layout">
    <div class="left-column">
      <div class="card">
        <h2 id="leftTitle">Entrada</h2>
        <label for="singleDomain" id="labelSingleDomain">Dominio √∫nico</label>
        <input id="singleDomain" type="text"
               placeholder="Ej: presidencia.gob.ec, example.com, gobierno.cl" />

        <div style="margin-top:0.75rem">
          <label for="fileInput" id="labelFile">O archivo .txt (un dominio por l√≠nea)</label>
          <div class="file-row">
            <button id="fileButton" type="button" class="btn-secondary">Seleccionar archivo</button>
            <span id="fileName" class="file-name">Sin archivo</span>
            <input id="fileInput" type="file" accept=".txt" />
          </div>
          <p class="small" id="fileHelp">
            El sistema limpiar√° formatos b√°sicos (http(s)://, barras, espacios, ; , y comodines *.).<br />
            Ejemplo de archivo:<br />
            presidencia.gob.ec<br />
            https://aduana.gob.ec;<br />
            *.registrocivil.gob.ec
          </p>
        </div>

        <div class="buttons-row">
          <button id="runButton" class="btn-primary">Analizar</button>
          <button id="cancelButton" class="btn-danger" disabled>Cancelar an√°lisis</button>
        </div>
        <div id="status" class="small"></div>

        <div id="progressWrapper" class="progress-wrapper">
          <div class="progress-bar-bg">
            <div id="progressBar" class="progress-bar-fill"></div>
          </div>
          <div id="progressText" class="progress-text"></div>
        </div>

        <div id="preview" class="preview" style="display:none;"></div>
        <div id="log" class="log"></div>
      </div>
    </div>

    <div class="right-column">
      <div class="card">
        <div class="actions-bar">
          <h2 id="rightTitle" style="margin:0;">Resultados</h2>
          <div style="display:flex; gap:0.4rem; flex-wrap:wrap;">
            <button id="downloadCsv" class="btn-secondary">Descargar CSV</button>
            <button id="downloadJson" class="btn-secondary">Descargar JSON</button>
          </div>
        </div>

        <div id="summary" class="summary">
          <div class="summary-grid">
            <div class="summary-item">
              <span class="summary-label" id="summaryLabelTotal">Dominios analizados</span>
              <span id="summaryTotal" class="summary-value">0</span>
            </div>
            <div class="summary-item">
              <span class="summary-label" id="summaryLabelSiteOk">Sitios que funcionan</span>
              <span id="summarySiteOk" class="summary-value">0 (0%)</span>
            </div>
            <div class="summary-item">
              <span class="summary-label" id="summaryLabelIPv6">Con IPv6</span>
              <span id="summaryIPv6" class="summary-value">0 (0%)</span>
            </div>
            <div class="summary-item">
              <span class="summary-label" id="summaryLabelDMARC">Con DMARC</span>
              <span id="summaryDMARC" class="summary-value">0 (0%)</span>
            </div>
          </div>
        </div>

        <div class="filters">
          <span id="filtersLabel">Filtros r√°pidos:</span>
          <label><input type="checkbox" id="filterNoIPv4" /> <span id="labelNoIPv4">Sin IPv4</span></label>
          <label><input type="checkbox" id="filterSiteProblem" /> <span id="labelSiteProblem">Sitio no funciona</span></label>
          <label><input type="checkbox" id="filterNoDMARC" /> <span id="labelNoDMARC">Sin DMARC</span></label>
        </div>

        <div class="table-container" style="margin-top:0.25rem;">
          <table id="resultsTable">
            <thead>
              <tr>
                <th id="thDomain">Dominio</th>
                <th>IPv4</th>
                <th>IPv6</th>
                <th>DNSSEC</th>
                <th>RPKI</th>
                <th>SPF</th>
                <th>DMARC</th>
                <th>DKIM</th>
                <th>HTTP sec.</th>
                <th>W3C</th>
                <th>HTTPS 200</th>
                <th id="thSiteWorks">Sitio funciona</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>

        <div class="note-toggle-row">
          <span id="infoToolText">Informaci√≥n sobre la herramienta:</span>
          <button id="toggleNoteBtn" class="btn-primary">
            VERSION EXPERIMENTAL (ver m√°s)
          </button>
        </div>

        <div id="noteBox" class="note-box" style="display:none;"></div>

        <div class="contact-box">
          <button id="contactBtn" class="btn-primary" onclick="location.href='mailto:sociedadinternetecuador@gmail.com'">
            PROBLEMAS / SUGERENCIAS
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="confirmOverlay" class="overlay">
    <div class="modal">
      <div class="modal-text" id="modalText">
        Esto cancelar√° el an√°lisis en marcha. ¬øEst√° seguro?
      </div>
      <div class="modal-buttons">
        <button id="confirmCancelContinue" class="btn-secondary">CONTINUAR</button>
        <button id="confirmCancelYes" class="btn-danger">SI CANCELA</button>
      </div>
    </div>
  </div>

  <script>
    const runButton = document.getElementById('runButton');
    const cancelButton = document.getElementById('cancelButton');
    const statusEl  = document.getElementById('status');
    const logEl     = document.getElementById('log');
    const resultsBody = document.getElementById('resultsBody');
    const singleDomainInput = document.getElementById('singleDomain');
    const fileInput = document.getElementById('fileInput');
    const fileButton = document.getElementById('fileButton');
    const fileNameLabel = document.getElementById('fileName');
    const downloadCsvButton = document.getElementById('downloadCsv');
    const downloadJsonButton = document.getElementById('downloadJson');

    const progressWrapper = document.getElementById('progressWrapper');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    const previewEl = document.getElementById('preview');
    const summaryEl = document.getElementById('summary');
    const summaryTotalEl = document.getElementById('summaryTotal');
    const summarySiteOkEl = document.getElementById('summarySiteOk');
    const summaryIPv6El = document.getElementById('summaryIPv6');
    const summaryDMARCEl = document.getElementById('summaryDMARC');

    const filterNoIPv4 = document.getElementById('filterNoIPv4');
    const filterSiteProblem = document.getElementById('filterSiteProblem');
    const filterNoDMARC = document.getElementById('filterNoDMARC');

    const confirmOverlay = document.getElementById('confirmOverlay');
    const confirmCancelYes = document.getElementById('confirmCancelYes');
    const confirmCancelContinue = document.getElementById('confirmCancelContinue');
    const toggleNoteBtn = document.getElementById('toggleNoteBtn');
    const noteBox = document.getElementById('noteBox');

    const langToggle = document.getElementById('langToggle');
    const langCode = document.getElementById('langCode');
    const langFlag = document.getElementById('langFlag');

    const titleMain = document.getElementById('titleMain');
    const subtitleMain = document.getElementById('subtitleMain');
    const noteMain = document.getElementById('noteMain');
    const leftTitle = document.getElementById('leftTitle');
    const rightTitle = document.getElementById('rightTitle');
    const labelSingleDomain = document.getElementById('labelSingleDomain');
    const labelFile = document.getElementById('labelFile');
    const fileHelp = document.getElementById('fileHelp');
    const filtersLabel = document.getElementById('filtersLabel');
    const labelNoIPv4 = document.getElementById('labelNoIPv4');
    const labelSiteProblemText = document.getElementById('labelSiteProblem');
    const labelNoDMARCText = document.getElementById('labelNoDMARC');
    const infoToolText = document.getElementById('infoToolText');
    const modalText = document.getElementById('modalText');
    const contactBtn = document.getElementById('contactBtn');
    const thDomain = document.getElementById('thDomain');
    const thSiteWorks = document.getElementById('thSiteWorks');

    let currentLang = 'es';

    const I18N = {
      es: {
        code: 'ES',
        flagClass: 'flag-ec',
        titleMain: 'Mediciones ISOC LAC',
        subtitleMain: 'Herramienta experimental para revisi√≥n r√°pida de dominios.',
        noteMain: 'V√°lido para cualquier dominio (incluidos dominios de 3er y 4to nivel).',
        leftTitle: 'Entrada',
        rightTitle: 'Resultados',
        singleDomainLabel: 'Dominio √∫nico',
        singleDomainPlaceholder: 'Ej: presidencia.gob.ec, example.com, gobierno.cl',
        fileLabel: 'O archivo .txt (un dominio por l√≠nea)',
        fileButton: 'Seleccionar archivo',
        fileNone: 'Sin archivo',
        fileHelp: 'El sistema limpiar√° formatos b√°sicos (http(s)://, barras, espacios, ; , y comodines *.).\nEjemplo de archivo:\npresidencia.gob.ec\nhttps://aduana.gob.ec;\n*.registrocivil.gob.ec',
        fileNoValid: 'No se encontraron dominios v√°lidos en el archivo.',
        filePreviewPrefix: 'Dominios detectados: ',
        filePreviewMore: ' Mostrando los primeros 10:',
        fileReadError: 'No se pudo leer el archivo para la vista previa.',
        statusNoInput: 'Escribe un dominio o selecciona un archivo .txt.',
        statusNoValidAfterClean: 'No se encontraron dominios v√°lidos despu√©s de limpiar el archivo.',
        statusAnalyzing: n => `Analizando ${n} dominio(s)...`,
        statusCanceled: 'An√°lisis cancelado.',
        statusCompleted: 'An√°lisis completado.',
        progressText: (c, t, p) => `Progreso: ${c} de ${t} dominios (${p}%)`,
        filtersLabel: 'Filtros r√°pidos:',
        noIPv4: 'Sin IPv4',
        siteProblem: 'Sitio no funciona',
        noDMARC: 'Sin DMARC',
        btnRun: 'Analizar',
        btnCancel: 'Cancelar an√°lisis',
        btnCsv: 'Descargar CSV',
        btnJson: 'Descargar JSON',
        modalText: 'Esto cancelar√° el an√°lisis en marcha. ¬øEst√° seguro?',
        modalContinue: 'CONTINUAR',
        modalYesCancel: 'SI CANCELA',
        noteToggleMore: 'VERSION EXPERIMENTAL (ver m√°s)',
        noteToggleLess: 'VERSION EXPERIMENTAL (ver menos)',
        infoTool: 'Informaci√≥n sobre la herramienta:',
        contactBtn: 'PROBLEMAS / SUGERENCIAS',
        noResultsExport: 'No hay resultados para exportar.',
        logCancelUserHtml: '<strong>‚èπ An√°lisis cancelado por el usuario.</strong>',
        thDomain: 'Dominio',
        thSiteWorks: 'Sitio funciona',
        noteHtml: `<b>Nota sobre esta versi√≥n experimental:</b><br>
          Esta herramienta analiza √∫nicamente el dominio ingresado (y su variante <i>www</i>).
          Los resultados se basan en consultas t√©cnicas directas al dominio evaluado y
          <b>no siguen redirecciones hacia otros dominios</b>, ni verifican configuraciones externas
          como servicios de correo alojados en otros nombres. Por esta raz√≥n, algunos dominios
          pueden aparecer como ‚ÄúNo‚Äù o ‚ÄúN/D‚Äù aunque su sitio final funcione correctamente o sus
          servicios est√©n configurados en otro subdominio o proveedor.<br><br>
          Los datos deben interpretarse como una <b>aproximaci√≥n t√©cnica inicial</b>, no como una
          verificaci√≥n exhaustiva del estado completo del dominio o de su infraestructura.`
      },
      en: {
        code: 'EN',
        flagClass: 'flag-us',
        titleMain: 'ISOC LAC Measurements',
        subtitleMain: 'Experimental tool for quick domain review.',
        noteMain: 'Valid for any domain (including 3rd and 4th level domains).',
        leftTitle: 'Input',
        rightTitle: 'Results',
        singleDomainLabel: 'Single domain',
        singleDomainPlaceholder: 'E.g.: presidencia.gob.ec, example.com, gobierno.cl',
        fileLabel: 'Or .txt file (one domain per line)',
        fileButton: 'Select file',
        fileNone: 'No file',
        fileHelp: 'The system will clean basic formats (http(s)://, slashes, spaces, ; , and *.).\nFile example:\npresidencia.gob.ec\nhttps://aduana.gob.ec;\n*.registrocivil.gob.ec',
        fileNoValid: 'No valid domains were found in the file.',
        filePreviewPrefix: 'Detected domains: ',
        filePreviewMore: ' Showing the first 10:',
        fileReadError: 'The file could not be read for preview.',
        statusNoInput: 'Type a domain or select a .txt file.',
        statusNoValidAfterClean: 'No valid domains were found after cleaning the file.',
        statusAnalyzing: n => `Analyzing ${n} domain(s)...`,
        statusCanceled: 'Analysis cancelled.',
        statusCompleted: 'Analysis completed.',
        progressText: (c, t, p) => `Progress: ${c} of ${t} domains (${p}%)`,
        filtersLabel: 'Quick filters:',
        noIPv4: 'No IPv4',
        siteProblem: 'Site not working',
        noDMARC: 'No DMARC',
        btnRun: 'Analyze',
        btnCancel: 'Cancel analysis',
        btnCsv: 'Download CSV',
        btnJson: 'Download JSON',
        modalText: 'This will cancel the running analysis. Are you sure?',
        modalContinue: 'CONTINUE',
        modalYesCancel: 'YES, CANCEL',
        noteToggleMore: 'EXPERIMENTAL VERSION (see more)',
        noteToggleLess: 'EXPERIMENTAL VERSION (see less)',
        infoTool: 'About this tool:',
        contactBtn: 'ISSUES / SUGGESTIONS',
        noResultsExport: 'There are no results to export.',
        logCancelUserHtml: '<strong>‚èπ Analysis cancelled by the user.</strong>',
        thDomain: 'Domain',
        thSiteWorks: 'Site works',
        noteHtml: `<b>Note on this experimental version:</b><br>
          This tool only analyzes the domain you enter (and its <i>www</i> variant).
          Results are based on technical checks performed directly on that domain and
          <b>do not follow redirects to other domains</b>, nor do they verify external configurations
          such as mail services hosted under different names. Because of this, some domains
          may appear as ‚ÄúNo‚Äù or ‚ÄúN/D‚Äù even if the final website works correctly or their
          services are configured on another subdomain or provider.<br><br>
          The data should be understood as an <b>initial technical approximation</b>, not as an
          exhaustive verification of the full state of the domain or its infrastructure.`
      }
    };

    function applyLang() {
      const t = I18N[currentLang];

      document.documentElement.lang = currentLang;

      if (langCode && langFlag) {
        langCode.textContent = t.code;
        langFlag.className = 'flag ' + t.flagClass;
        langFlag.textContent = (currentLang === 'es' ? '\U0001F1EA\U0001F1E8' : '\U0001F1FA\U0001F1F8');
      }

      if (titleMain) titleMain.textContent = t.titleMain;
      if (subtitleMain) subtitleMain.textContent = t.subtitleMain;
      if (noteMain) noteMain.textContent = t.noteMain;

      if (leftTitle) leftTitle.textContent = t.leftTitle;
      if (rightTitle) rightTitle.textContent = t.rightTitle;

      if (labelSingleDomain) labelSingleDomain.textContent = t.singleDomainLabel;
      if (singleDomainInput) singleDomainInput.placeholder = t.singleDomainPlaceholder;

      if (labelFile) labelFile.textContent = t.fileLabel;
      if (fileButton) fileButton.textContent = t.fileButton;
      if (fileNameLabel && !fileInput.files[0]) fileNameLabel.textContent = t.fileNone;

      if (fileHelp) fileHelp.innerText = t.fileHelp.replace(/\n/g, '\n');

      if (runButton) runButton.textContent = t.btnRun;
      if (cancelButton) cancelButton.textContent = t.btnCancel;

      if (downloadCsvButton) downloadCsvButton.textContent = t.btnCsv;
      if (downloadJsonButton) downloadJsonButton.textContent = t.btnJson;

      if (filtersLabel) filtersLabel.textContent = t.filtersLabel;
      if (labelNoIPv4) labelNoIPv4.textContent = t.noIPv4;
      if (labelSiteProblemText) labelSiteProblemText.textContent = t.siteProblem;
      if (labelNoDMARCText) labelNoDMARCText.textContent = t.noDMARC;

      if (infoToolText) infoToolText.textContent = t.infoTool;
      if (modalText) modalText.textContent = t.modalText;
      if (confirmCancelContinue) confirmCancelContinue.textContent = t.modalContinue;
      if (confirmCancelYes) confirmCancelYes.textContent = t.modalYesCancel;

      if (contactBtn) contactBtn.textContent = t.contactBtn;

      if (thDomain) thDomain.textContent = t.thDomain;
      if (thSiteWorks) thSiteWorks.textContent = t.thSiteWorks;

      const noteBoxEl = document.getElementById('noteBox');
      if (noteBoxEl) {
        noteBoxEl.innerHTML = t.noteHtml;
      }

      if (toggleNoteBtn) {
        const isHidden = noteBoxEl && (noteBoxEl.style.display === '' || noteBoxEl.style.display === 'none');
        toggleNoteBtn.textContent = isHidden ? t.noteToggleMore : t.noteToggleLess;
      }
    }

    if (langToggle) {
      langToggle.addEventListener('click', () => {
        currentLang = currentLang === 'es' ? 'en' : 'es';
        applyLang();
      });
      applyLang();
    }



    let cancelRequested = false;
    let isAnalyzing = false;
    let allResults = [];

    fileButton.addEventListener('click', () => {
      if (isAnalyzing) return;
      fileInput.click();
    });

    fileInput.addEventListener('change', async () => {
      if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        fileNameLabel.textContent = file.name;

        try {
          const text = await file.text();
          const lines = text.split(/\r?\n/);
          const domains = Array.from(new Set(
            lines
              .map(normalizeDomain)
              .filter(d => d.length > 0)
          ));
          if (domains.length === 0) {
            previewEl.style.display = 'block';
            previewEl.textContent = I18N[currentLang].fileNoValid;
          } else {
            const previewList = domains.slice(0, 10).join('\n');
            previewEl.style.display = 'block';
            previewEl.textContent =
              `Dominios detectados: ${domains.length}.` +
              (domains.length > 10
                ? ` Mostrando los primeros 10:\n` + previewList
                : `\n` + previewList);
          }
        } catch (e) {
          previewEl.style.display = 'block';
          previewEl.textContent = I18N[currentLang].fileReadError;
        }
      } else {
        fileNameLabel.textContent = I18N[currentLang].fileNone;
        previewEl.style.display = 'none';
        previewEl.textContent = '';
      }
    });

    function log(msg, isHtml = false) {
      if (!logEl.innerHTML) logEl.style.display = 'block';
      if (isHtml) {
        logEl.innerHTML += msg + '<br>';
      } else {
        const escaped = String(msg)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
        logEl.innerHTML += escaped + '<br>';
      }
      logEl.scrollTop = logEl.scrollHeight;
    }

    function resetLog() {
      logEl.innerHTML = '';
      logEl.style.display = 'none';
    }

    function normalizeDomain(d) {
      if (!d) return '';
      let s = String(d).trim().toLowerCase();
      if (!s) return '';

      // cortar en el primer separador fuerte (; , espacio, tab)
      s = s.split(/[;,\s]+/)[0];

      // quitar esquema http(s)
      s = s.replace(/^https?:\/\//, '');

      // quitar ruta si existe
      const slashIndex = s.indexOf('/');
      if (slashIndex !== -1) {
        s = s.slice(0, slashIndex);
      }

      // quitar comod√≠n *.
      if (s.startsWith('*.')) {
        s = s.slice(2);
      }

      // quitar puntos iniciales redundantes y finales
      s = s.replace(/^\.+/, '');
      s = s.replace(/\.+$/, '');

      return s;
    }

    async function analyzeDomain(domain) {
      const base = '';

      async function safeFetch(path) {
        try {
          const res = await fetch(base + path);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return await res.json();
        } catch (e) {
          return { error: e.message || 'error' };
        }
      }

      const wwwDomain = domain.startsWith('www.') ? domain : 'www.' + domain;

      const [
        dnsrecords,
        dnssecurity,
        rpki,
        emailconfig,
        httpsecurity,
        w3c,
        headersMain,
        headersWww
      ] = await Promise.all([
        safeFetch('/dnsrecords/' + encodeURIComponent(domain)),
        safeFetch('/dnssecurity/' + encodeURIComponent(domain)),
        safeFetch('/rpki/' + encodeURIComponent(domain)),
        safeFetch('/emailconfig/' + encodeURIComponent(domain)),
        safeFetch('/httpsecurity/' + encodeURIComponent(domain)),
        safeFetch('/w3c/' + encodeURIComponent(domain)),
        safeFetch('/headers/' + encodeURIComponent(domain)),
        safeFetch('/headers/' + encodeURIComponent(wwwDomain))
      ]);

      const hasIPv4 = dnsrecords && dnsrecords.records &&
                      Array.isArray(dnsrecords.records.A) &&
                      dnsrecords.records.A.length > 0;

      const hasIPv6 = dnsrecords && dnsrecords.records &&
                      Array.isArray(dnsrecords.records.AAAA) &&
                      dnsrecords.records.AAAA.length > 0;

      const dnssecOK = dnssecurity && dnssecurity.valid === true;
      const rpkiOK   = (rpki && rpki.state === 'valid') || (rpki && rpki.valid === true);

      const spfOK   = emailconfig && emailconfig.spf === true;
      const dmarcOK = emailconfig && emailconfig.dmarc === true;
      const dkimOK  = emailconfig && emailconfig.dkim === true;

      const httpOK = httpsecurity && httpsecurity.security &&
                     (httpsecurity.security.hsts ||
                      httpsecurity.security.csp ||
                      httpsecurity.security.xfo ||
                      httpsecurity.security.xcto ||
                      httpsecurity.security.xxss);

      let w3cOK = null;
      if (w3c && typeof w3c.errors === 'number') {
        w3cOK = w3c.errors === 0;
      }

      // Interpretar headers para HTTPS 200 y sitio funciona (dominio y www)
      let anyHeaders = false;
      let anyHttpsTrue = false;
      let anySiteTrue = false;

      function considerHeaders(h) {
        if (!h || h.error) return;
        anyHeaders = true;
        if (h.https === true) anyHttpsTrue = true;
        if (h.https === true || h.redirect === true) anySiteTrue = true;
      }

      considerHeaders(headersMain);
      considerHeaders(headersWww);

      let https200 = null;
      let siteOK = null;
      if (anyHeaders) {
        https200 = anyHttpsTrue;
        siteOK = anySiteTrue;
      }

      return {
        domain,
        hasIPv4,
        hasIPv6,
        dnssecOK,
        rpkiOK,
        spfOK,
        dmarcOK,
        dkimOK,
        httpOK,
        w3cOK,
        https200,
        siteOK
      };
    }

    function resultCell(okValue) {
      if (okValue === null || typeof okValue === 'undefined') {
        return '<span class="warn">N/D</span>';
      }
      return okValue
        ? '<span class="ok">OK</span>'
        : '<span class="bad">No</span>';
    }

    function appendResultRow(result) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${result.domain}</td>
        <td>${resultCell(result.hasIPv4)}</td>
        <td>${resultCell(result.hasIPv6)}</td>
        <td>${resultCell(result.dnssecOK)}</td>
        <td>${resultCell(result.rpkiOK)}</td>
        <td>${resultCell(result.spfOK)}</td>
        <td>${resultCell(result.dmarcOK)}</td>
        <td>${resultCell(result.dkimOK)}</td>
        <td>${resultCell(result.httpOK)}</td>
        <td>${resultCell(result.w3cOK)}</td>
        <td>${resultCell(result.https200)}</td>
        <td>${resultCell(result.siteOK)}</td>
      `;
      resultsBody.appendChild(tr);
    }

    function setAnalyzingState(active) {
      isAnalyzing = active;
      runButton.disabled = active;
      cancelButton.disabled = !active;
      fileInput.disabled = active;
      fileButton.disabled = active;
      singleDomainInput.disabled = active;
      if (downloadCsvButton) downloadCsvButton.disabled = active;
      if (downloadJsonButton) downloadJsonButton.disabled = active;
      progressWrapper.style.display = active ? 'block' : 'none';
      if (!active) {
        progressBar.style.width = '0%';
        progressText.textContent = '';
      }
    }

    function updateProgress(current, total) {
      if (!total || total <= 0) return;
      const pct = Math.round((current / total) * 100);
      progressBar.style.width = pct + '%';
      progressText.textContent = I18N[currentLang].progressText(current, total, pct);
    }

    function updateSummary() {
      const total = allResults.length;
      if (!total) {
        summaryEl.style.display = 'none';
        summaryTotalEl.textContent = '0';
        summarySiteOkEl.textContent = '0 (0%)';
        summaryIPv6El.textContent = '0 (0%)';
        summaryDMARCEl.textContent = '0 (0%)';
        return;
      }
      let siteOkCount = 0;
      let ipv6Count = 0;
      let dmarcCount = 0;

      for (const r of allResults) {
        if (r.siteOK === true) siteOkCount++;
        if (r.hasIPv6 === true) ipv6Count++;
        if (r.dmarcOK === true) dmarcCount++;
      }

      function pct(count) {
        return Math.round((count / total) * 100);
      }

      summaryEl.style.display = 'block';
      summaryTotalEl.textContent = String(total);
      summarySiteOkEl.textContent = `${siteOkCount} (${pct(siteOkCount)}%)`;
      summaryIPv6El.textContent = `${ipv6Count} (${pct(ipv6Count)}%)`;
      summaryDMARCEl.textContent = `${dmarcCount} (${pct(dmarcCount)}%)`;
    }

    function applyFilters() {
      const noIPv4 = filterNoIPv4.checked;
      const siteProblem = filterSiteProblem.checked;
      const noDMARC = filterNoDMARC.checked;

      const rows = resultsBody.querySelectorAll('tr');
      rows.forEach((tr, idx) => {
        const r = allResults[idx];
        if (!r) {
          tr.style.display = '';
          return;
        }
        let visible = true;
        if (noIPv4 && r.hasIPv4 !== false) visible = false;
        if (siteProblem && !(r.siteOK === false)) visible = false;
        if (noDMARC && r.dmarcOK !== false) visible = false;
        tr.style.display = visible ? '' : 'none';
      });
    }

    filterNoIPv4.addEventListener('change', applyFilters);
    filterSiteProblem.addEventListener('change', applyFilters);
    filterNoDMARC.addEventListener('change', applyFilters);

    runButton.addEventListener('click', async () => {
      if (isAnalyzing) return;

      statusEl.textContent = '';
      resetLog();
      resultsBody.innerHTML = '';
      allResults = [];
      cancelRequested = false;
      updateSummary();
      applyFilters();
      previewEl.style.display = 'none';
      previewEl.textContent = '';

      const single = normalizeDomain(singleDomainInput.value);
      const file = fileInput.files[0];

      let domains = [];

      if (file) {
        const text = await file.text();
        domains = text
          .split(/\r?\n/)
          .map(normalizeDomain)
          .filter(d => d.length > 0);
      } else if (single) {
        domains = [single];
      } else {
        statusEl.textContent = I18N[currentLang].statusNoInput;
        return;
      }

      domains = Array.from(new Set(domains));

      if (!domains.length) {
        statusEl.textContent = I18N[currentLang].statusNoValidAfterClean;
        return;
      }

      statusEl.textContent = I18N[currentLang].statusAnalyzing(domains.length);
      setAnalyzingState(true);

      for (let i = 0; i < domains.length; i++) {
        if (cancelRequested) {
          log(I18N[currentLang].logCancelUserHtml, true);
          break;
        }
        const d = domains[i];
        log(currentLang === 'es' ? `‚ñ∂ Analizando ${d} (${i + 1}/${domains.length})...` : `‚ñ∂ Checking ${d} (${i + 1}/${domains.length})...`);
        updateProgress(i, domains.length);
        try {
          const result = await analyzeDomain(d);
          appendResultRow(result);
          allResults.push(result);
          log(currentLang === 'es' ? `‚úî Listo ${d}` : `‚úî Done ${d}`);
        } catch (e) {
          log(currentLang === 'es' ? `‚úñ Error en ${d}: ${e.message || e}` : `‚úñ Error on ${d}: ${e.message || e}`);
          const emptyResult = {
            domain: d,
            hasIPv4: null,
            hasIPv6: null,
            dnssecOK: null,
            rpkiOK: null,
            spfOK: null,
            dmarcOK: null,
            dkimOK: null,
            httpOK: null,
            w3cOK: null,
            https200: null,
            siteOK: null
          };
          appendResultRow(emptyResult);
          allResults.push(emptyResult);
        }
      }

      updateProgress(domains.length, domains.length);
      updateSummary();
      applyFilters();

      if (cancelRequested) {
        statusEl.innerHTML = '<strong>' + I18N[currentLang].statusCanceled + '</strong>';
      } else {
        statusEl.textContent = I18N[currentLang].statusCompleted;
      }

      // Limpia el archivo para evitar reusar el mismo listado sin querer
      fileInput.value = '';
      fileNameLabel.textContent = I18N[currentLang].fileNone;
      setAnalyzingState(false);
      cancelRequested = false;
    });

    cancelButton.addEventListener('click', () => {
      if (!isAnalyzing) return;
      confirmOverlay.style.display = 'flex';
    });

    confirmCancelContinue.addEventListener('click', () => {
      confirmOverlay.style.display = 'none';
    });

    confirmCancelYes.addEventListener('click', () => {
      cancelRequested = true;
      confirmOverlay.style.display = 'none';
      // limpia el archivo cargado para permitir un nuevo an√°lisis inmediato
      fileInput.value = '';
      fileNameLabel.textContent = I18N[currentLang].fileNone;
    });

    downloadCsvButton.addEventListener('click', () => {
      if (!allResults.length) {
        alert(I18N[currentLang].noResultsExport);
        return;
      }
      const header = [
        'Dominio',
        'IPv4',
        'IPv6',
        'DNSSEC',
        'RPKI',
        'SPF',
        'DMARC',
        'DKIM',
        'HTTP_sec',
        'W3C',
        'HTTPS_200',
        'Sitio_funciona'
      ];
      const rows = [header.join(',')];

      function val(v) {
        if (v === null || typeof v === 'undefined') return 'N/D';
        return v ? 'OK' : 'No';
      }

      for (const r of allResults) {
        rows.push([
          r.domain,
          val(r.hasIPv4),
          val(r.hasIPv6),
          val(r.dnssecOK),
          val(r.rpkiOK),
          val(r.spfOK),
          val(r.dmarcOK),
          val(r.dkimOK),
          val(r.httpOK),
          r.w3cOK === null || typeof r.w3cOK === 'undefined'
            ? 'N/D'
            : r.w3cOK
            ? 'OK'
            : 'No',
          val(r.https200),
          val(r.siteOK)
        ].join(','));
      }

      const csvContent = rows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'mediciones_isoc_lac.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    downloadJsonButton.addEventListener('click', () => {
      if (!allResults.length) {
        alert(I18N[currentLang].noResultsExport);
        return;
      }
      const jsonContent = JSON.stringify(allResults, null, 2);
      const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'mediciones_isoc_lac.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Toggle nota versi√≥n experimental
    if (toggleNoteBtn && noteBox) {
      noteBox.style.display = 'none';
      toggleNoteBtn.addEventListener('click', () => {
        const isHidden = noteBox.style.display === '' || noteBox.style.display === 'none';
        noteBox.style.display = isHidden ? 'block' : 'none';
        const t = I18N[currentLang];
        toggleNoteBtn.textContent = isHidden ? t.noteToggleLess : t.noteToggleMore;
      });
    }

  </script>
</body>
</html>
