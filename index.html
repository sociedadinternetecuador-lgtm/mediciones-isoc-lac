<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Analizador – Versión Experimental</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #f4f6fb;
      color: #111827;
      padding: 1.5rem;
    }

    .app {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
      padding: 1.75rem 1.5rem 1.75rem;
    }

    header {
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 1rem;
      margin-bottom: 1.25rem;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.3rem;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 0.8rem;
    }

    .top-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      justify-content: flex-end;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.15s;
      white-space: nowrap;
    }

    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.55;
      box-shadow: none;
      transform: none;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.16);
    }

    .btn-accent {
      background: #0ea5e9;
      color: white;
      box-shadow: 0 2px 5px rgba(14, 165, 233, 0.45);
    }

    .btn-accent:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.2);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid #d1d5db;
      color: #374151;
    }

    .btn-primary {
      background: #22c55e;
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.45);
    }

    .tag {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: #eef2ff;
      color: #4f46e5;
      border-radius: 999px;
      padding: 0.15rem 0.6rem;
    }

    .version-note {
      background: #eff6ff;
      border-left: 3px solid #0ea5e9;
      padding: 0.6rem 0.75rem;
      border-radius: 0.75rem;
      margin-top: 0.7rem;
      font-size: 0.8rem;
      color: #1f2937;
    }

    .hidden {
      display: none;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 1.25rem;
      margin-bottom: 1rem;
    }

    @media (max-width: 840px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    section {
      background: #f9fafb;
      border-radius: 0.9rem;
      padding: 1rem;
      border: 1px solid #e5e7eb;
    }

    section h2 {
      font-size: 1rem;
      margin-bottom: 0.4rem;
    }

    section p.desc {
      font-size: 0.82rem;
      color: #6b7280;
      margin-bottom: 0.8rem;
    }

    label {
      font-size: 0.8rem;
      font-weight: 500;
      color: #374151;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-bottom: 0.35rem;
    }

    textarea {
      width: 100%;
      min-height: 180px;
      resize: vertical;
      font-size: 0.85rem;
      padding: 0.6rem 0.7rem;
      border-radius: 0.75rem;
      border: 1px solid #d4d4d8;
      outline: none;
      background: #ffffff;
    }

    textarea:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.35);
    }

    .input-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.7rem;
      flex-wrap: wrap;
    }

    .status {
      font-size: 0.78rem;
      color: #6b7280;
      margin-top: 0.4rem;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #10b981;
    }

    .status-dot.running {
      background: #f97316;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.8;}
      50% { transform: scale(1.4); opacity: 0.4;}
      100% { transform: scale(1); opacity: 0.8;}
    }

    #results {
      font-size: 0.86rem;
      color: #111827;
      background: #ffffff;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      padding: 0.7rem;
      min-height: 120px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .results-placeholder {
      color: #9ca3af;
      font-style: italic;
    }

    .downloads {
      margin-top: 0.7rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: flex-end;
    }

    footer {
      border-top: 1px solid #e5e7eb;
      padding-top: 0.8rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.6rem;
      font-size: 0.78rem;
      color: #6b7280;
    }

    footer small span {
      font-weight: 500;
      color: #4b5563;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:0.75rem;">
        <div>
          <h1 id="t-title">Analizador de datos</h1>
          <p class="subtitle" id="t-subtitle">Herramienta local de apoyo orientativo para revisar resultados.</p>
          <span class="tag">BETA</span>
        </div>

        <div class="top-actions">
          <button id="langBtn" class="btn btn-accent" type="button">
            EN
          </button>
          <button id="versionBtn" class="btn btn-accent" type="button">
            VERSIÓN EXPERIMENTAL (ver más)
          </button>
          <button id="feedbackBtn" class="btn btn-accent" type="button">
            PROBLEMAS / SUGERENCIAS
          </button>
        </div>
      </div>

      <div id="versionNote" class="version-note hidden">
        <strong id="t-exp-title">Versión Experimental:</strong>
        <span id="t-exp-desc">
          Esta herramienta está en pruebas. Los resultados pueden contener errores o análisis incompletos.
          Úsala solo como apoyo orientativo y revisa siempre con criterio propio antes de tomar decisiones.
        </span>
      </div>
    </header>

    <main>
      <!-- PANEL IZQUIERDO: ENTRADA / ANÁLISIS -->
      <section>
        <h2 id="t-step1-title">1. Pega o carga la información a analizar</h2>
        <p class="desc" id="t-step1-desc">
          Puedes pegar aquí el contenido que quieras analizar. Luego haz clic en <strong>“Analizar”</strong>.
        </p>

        <label for="inputText" id="t-data-label">
          Datos a analizar
        </label>
        <textarea id="inputText" placeholder="Pega aquí la información que quieres analizar…"></textarea>

        <div class="input-actions">
          <button id="cancelBtn" class="btn btn-outline" type="button" disabled>
            Cancelar análisis
          </button>
          <button id="analyzeBtn" class="btn btn-primary" type="button">
            Analizar
          </button>
        </div>

        <div class="status" id="statusLine">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">Listo para analizar.</span>
        </div>
      </section>

      <!-- PANEL DERECHO: RESULTADOS / DESCARGAS -->
      <section>
        <h2 id="t-step2-title">2. Resultados</h2>
        <p class="desc" id="t-step2-desc">
          Aquí aparecerá un resumen del análisis. Una vez completo podrás descargarlo en CSV o JSON.
        </p>

        <div id="results">
          <span class="results-placeholder" id="t-results-placeholder">
            No hay resultados todavía. Ejecuta un análisis para ver el contenido aquí.
          </span>
        </div>

        <div class="downloads">
          <button id="downloadCsvBtn" class="btn btn-outline" type="button" disabled>
            Bajar CSV
          </button>
          <button id="downloadJsonBtn" class="btn btn-outline" type="button" disabled>
            Bajar JSON
          </button>
        </div>
      </section>
    </main>

    <footer>
      <small>
        <span id="t-footer-note-label">Nota:</span>
        <span id="t-footer-note-text">
          mientras el análisis esté en curso, los botones de descarga se desactivan para evitar bajar archivos incompletos.
        </span>
      </small>
      <small>&copy; <span id="year"></span> <span id="t-footer-right">Herramienta local – uso interno.</span></small>
    </footer>
  </div>

  <script>
    // --- TRADUCCIONES ---
    let lang = "es";

    const T = {
      es: {
        title: "Analizador de datos",
        subtitle: "Herramienta local de apoyo orientativo para revisar resultados.",
        versionBtnShow: "VERSIÓN EXPERIMENTAL (ver más)",
        versionBtnHide: "VERSIÓN EXPERIMENTAL (ocultar)",
        expTitle: "Versión Experimental:",
        expDesc: "Esta herramienta está en pruebas. Los resultados pueden contener errores o análisis incompletos. Úsala solo como apoyo orientativo y revisa siempre con criterio propio antes de tomar decisiones.",
        step1Title: "1. Pega o carga la información a analizar",
        step1Desc: "Puedes pegar aquí el contenido que quieras analizar. Luego haz clic en “Analizar”.",
        dataLabel: "Datos a analizar",
        textareaPlaceholder: "Pega aquí la información que quieres analizar…",
        cancelBtn: "Cancelar análisis",
        analyzeBtn: "Analizar",
        statusReady: "Listo para analizar.",
        statusAnalyzing: "Analizando… por favor espera.",
        statusCanceled: "<strong>Análisis cancelado.</strong>",
        statusCanceledUser: "<strong>Análisis cancelado por el usuario.</strong>",
        step2Title: "2. Resultados",
        step2Desc: "Aquí aparecerá un resumen del análisis. Una vez completo podrás descargarlo en CSV o JSON.",
        resultsPlaceholder: "No hay resultados todavía. Ejecuta un análisis para ver el contenido aquí.",
        downloadCsv: "Bajar CSV",
        downloadJson: "Bajar JSON",
        footerNoteLabel: "Nota:",
        footerNoteText: "mientras el análisis esté en curso, los botones de descarga se desactivan para evitar bajar archivos incompletos.",
        footerRight: "Herramienta local – uso interno.",
        alertNoText: "Por favor, pega algún contenido para analizar.",
        emailBody: "Hola,\n\nQuisiera reportar un problema / sugerencia sobre la herramienta:\n\n(Escribe aquí tu comentario)\n",
        resumenLabel: "Resumen:",
        lenLabel: "Longitud del texto analizado:",
        previewLabel: "Vista previa del contenido:"
      },
      en: {
        title: "Data analyzer",
        subtitle: "Local tool to help you quickly review results.",
        versionBtnShow: "EXPERIMENTAL VERSION (more info)",
        versionBtnHide: "EXPERIMENTAL VERSION (hide)",
        expTitle: "Experimental version:",
        expDesc: "This tool is in testing. Results may contain errors or incomplete analysis. Use it only as guidance and always double-check before making decisions.",
        step1Title: "1. Paste or load the information to analyze",
        step1Desc: "You can paste here the content you want to analyze, then click “Analyze”.",
        dataLabel: "Data to analyze",
        textareaPlaceholder: "Paste here the information you want to analyze…",
        cancelBtn: "Cancel analysis",
        analyzeBtn: "Analyze",
        statusReady: "Ready to analyze.",
        statusAnalyzing: "Analyzing… please wait.",
        statusCanceled: "<strong>Analysis cancelled.</strong>",
        statusCanceledUser: "<strong>Analysis cancelled by the user.</strong>",
        step2Title: "2. Results",
        step2Desc: "A summary of the analysis will appear here. Once complete, you can download it as CSV or JSON.",
        resultsPlaceholder: "No results yet. Run an analysis to view the content here.",
        downloadCsv: "Download CSV",
        downloadJson: "Download JSON",
        footerNoteLabel: "Note:",
        footerNoteText: "while the analysis is running, the download buttons are disabled to avoid incomplete files.",
        footerRight: "Local tool – internal use only.",
        alertNoText: "Please paste some content to analyze.",
        emailBody: "Hi,\n\nI would like to report a problem / suggestion about the tool:\n\n(Write your comment here)\n",
        resumenLabel: "Summary:",
        lenLabel: "Length of analyzed text:",
        previewLabel: "Content preview:"
      }
    };

    // --- ELEMENTOS BÁSICOS ---
    const versionBtn = document.getElementById("versionBtn");
    const versionNote = document.getElementById("versionNote");
    const feedbackBtn = document.getElementById("feedbackBtn");
    const langBtn = document.getElementById("langBtn");

    const analyzeBtn = document.getElementById("analyzeBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const inputText = document.getElementById("inputText");
    const resultsBox = document.getElementById("results");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");

    const downloadCsvBtn = document.getElementById("downloadCsvBtn");
    const downloadJsonBtn = document.getElementById("downloadJsonBtn");

    const tTitle = document.getElementById("t-title");
    const tSubtitle = document.getElementById("t-subtitle");
    const tExpTitle = document.getElementById("t-exp-title");
    const tExpDesc = document.getElementById("t-exp-desc");
    const tStep1Title = document.getElementById("t-step1-title");
    const tStep1Desc = document.getElementById("t-step1-desc");
    const tDataLabel = document.getElementById("t-data-label");
    const tResultsPlaceholder = document.getElementById("t-results-placeholder");
    const tStep2Title = document.getElementById("t-step2-title");
    const tStep2Desc = document.getElementById("t-step2-desc");
    const tFooterNoteLabel = document.getElementById("t-footer-note-label");
    const tFooterNoteText = document.getElementById("t-footer-note-text");
    const tFooterRight = document.getElementById("t-footer-right");

    let hasResults = false;
    let analysisRunning = false;
    let currentAnalysisData = null; // resultado estructurado de tu análisis real
    let analysisTimeoutId = null;

    // --- AÑO EN FOOTER ---
    document.getElementById("year").textContent = new Date().getFullYear();

    // --- APLICAR IDIOMA ---
    function applyLang() {
      const tr = T[lang];

      tTitle.textContent = tr.title;
      tSubtitle.textContent = tr.subtitle;
      tExpTitle.textContent = tr.expTitle;
      tExpDesc.textContent = tr.expDesc;
      tStep1Title.textContent = tr.step1Title;
      tStep1Desc.textContent = tr.step1Desc;
      tDataLabel.textContent = tr.dataLabel;
      inputText.placeholder = tr.textareaPlaceholder;
      cancelBtn.textContent = tr.cancelBtn;
      analyzeBtn.textContent = tr.analyzeBtn;
      tStep2Title.textContent = tr.step2Title;
      tStep2Desc.textContent = tr.step2Desc;
      tResultsPlaceholder.textContent = tr.resultsPlaceholder;
      downloadCsvBtn.textContent = tr.downloadCsv;
      downloadJsonBtn.textContent = tr.downloadJson;
      tFooterNoteLabel.textContent = tr.footerNoteLabel;
      tFooterNoteText.textContent = tr.footerNoteText;
      tFooterRight.textContent = tr.footerRight;

      // Botón de idioma: muestra el idioma al que cambiará
      langBtn.textContent = lang === "es" ? "EN" : "ES";

      // Botón de versión experimental según estado actual
      if (versionNote.classList.contains("hidden")) {
        versionBtn.textContent = tr.versionBtnShow;
      } else {
        versionBtn.textContent = tr.versionBtnHide;
      }

      // Estado: solo actualizamos a "listo" si no hay análisis en curso
      if (!analysisRunning && !hasResults) {
        statusText.textContent = tr.statusReady;
      }
    }

    // --- TOGGLE IDIOMA ---
    langBtn.addEventListener("click", () => {
      lang = lang === "es" ? "en" : "es";
      applyLang();
    });

    // --- TOGGLE VERSIÓN EXPERIMENTAL ---
    versionBtn.addEventListener("click", () => {
      const tr = T[lang];
      const isHidden = versionNote.classList.contains("hidden");
      if (isHidden) {
        versionNote.classList.remove("hidden");
        versionBtn.textContent = tr.versionBtnHide;
      } else {
        versionNote.classList.add("hidden");
        versionBtn.textContent = tr.versionBtnShow;
      }
    });

    // --- BOTÓN PROBLEMAS / SUGERENCIAS ---
    feedbackBtn.addEventListener("click", () => {
      const tr = T[lang];
      const subject = encodeURIComponent("[Analizador] Problemas / Sugerencias");
      const body = encodeURIComponent(tr.emailBody);
      window.location.href = `mailto:contacto@universitarios.info?subject=${subject}&body=${body}`;
    });

    // --- MANEJO DE ESTADO DE ANÁLISIS ---
    function actualizarEstadoAnalisis(enEjecucion) {
      const tr = T[lang];
      analysisRunning = enEjecucion;

      if (enEjecucion) {
        statusDot.classList.add("running");
        statusText.textContent = tr.statusAnalyzing;
        analyzeBtn.disabled = true;
        cancelBtn.disabled = false;
      } else {
        statusDot.classList.remove("running");
        if (!hasResults) {
          statusText.textContent = tr.statusReady;
        }
        analyzeBtn.disabled = false;
        cancelBtn.disabled = true;
      }

      // Mientras se analiza, las descargas SIEMPRE deshabilitadas
      // Cuando termina, solo se habilitan si hay resultados
      downloadCsvBtn.disabled = enEjecucion || !hasResults;
      downloadJsonBtn.disabled = enEjecucion || !hasResults;
    }

    function resultadosPlaceholder(textHtml) {
      const span = document.createElement("span");
      span.className = "results-placeholder";
      span.innerHTML = textHtml;
      resultsBox.innerHTML = "";
      resultsBox.appendChild(span);
    }

    // --- LÓGICA PRINCIPAL DE ANÁLISIS ---
    analyzeBtn.addEventListener("click", () => {
      const tr = T[lang];
      const texto = inputText.value.trim();
      if (!texto) {
        alert(tr.alertNoText);
        return;
      }

      // Si ya hay un análisis en curso, lo cancelamos genéricamente
      if (analysisRunning && analysisTimeoutId !== null) {
        clearTimeout(analysisTimeoutId);
        analysisTimeoutId = null;
        hasResults = false;
        currentAnalysisData = null;
        statusText.innerHTML = tr.statusCanceled;
        resultadosPlaceholder(tr.statusCanceled);
        actualizarEstadoAnalisis(false);
      }

      // Limpiar resultados previos antes del nuevo análisis
      hasResults = false;
      currentAnalysisData = null;
      resultadosPlaceholder(tr.statusAnalyzing);

      actualizarEstadoAnalisis(true);

      // Simulación de análisis: reemplaza este setTimeout por tu llamada real
      analysisTimeoutId = setTimeout(() => {
        // EJEMPLO DE RESULTADO DE MUESTRA (reemplaza por tu lógica real)
        const resultadoEjemplo = {
          resumen: lang === "es" ? "Análisis de ejemplo completado." : "Sample analysis completed.",
          longitudTexto: texto.length,
          vistaPrevia: texto.slice(0, 200)
        };

        onAnalysisFinished(resultadoEjemplo);
      }, 1500);
    });

    function onAnalysisFinished(data) {
      const tr = T[lang];
      analysisTimeoutId = null;
      // Guardar el resultado estructurado para CSV/JSON
      currentAnalysisData = data;
      hasResults = true;

      // Mostrar de forma legible en pantalla (ajusta según tu análisis real)
      resultsBox.innerHTML = "";
      const resumen = document.createElement("div");
      resumen.innerHTML =
        "<strong>" + tr.resumenLabel + "</strong> " + (data.resumen || (lang === "es" ? "Sin resumen" : "No summary")) + "<br><br>" +
        "<strong>" + tr.lenLabel + "</strong> " + (data.longitudTexto ?? "N/D") + "<br><br>" +
        "<strong>" + tr.previewLabel + "</strong><br>" +
        "<pre style='white-space:pre-wrap; font-size:0.8rem; margin-top:0.25rem;'>" +
        (data.vistaPrevia || (lang === "es" ? "(Sin vista previa)" : "(No preview)")) +
        "</pre>";

      resultsBox.appendChild(resumen);

      // Termina el estado de análisis y habilita descargas
      actualizarEstadoAnalisis(false);
    }

    // --- CANCELAR ANÁLISIS POR EL USUARIO ---
    cancelBtn.addEventListener("click", () => {
      const tr = T[lang];
      if (analysisRunning && analysisTimeoutId !== null) {
        clearTimeout(analysisTimeoutId);
        analysisTimeoutId = null;
        analysisRunning = false;
        hasResults = false;
        currentAnalysisData = null;

        statusText.innerHTML = tr.statusCanceledUser;
        resultadosPlaceholder(tr.statusCanceledUser);

        actualizarEstadoAnalisis(false);
      }
    });

    // --- DESCARGA CSV ---
    downloadCsvBtn.addEventListener("click", () => {
      if (!hasResults || !currentAnalysisData) {
        const tr = T[lang];
        alert(tr.alertNoText);
        return;
      }

      // Convierte el objeto actual a un CSV simple (clave, valor)
      const filas = [["campo", "valor"]];
      for (const [clave, valor] of Object.entries(currentAnalysisData)) {
        const limpio = String(valor).replace(/\r?\n/g, " ");
        filas.push([clave, limpio]);
      }

      const csvContenido = filas
        .map(row => row.map(v => '"' + v.replace(/"/g, '""') + '"').join(","))
        .join("\r\n");

      descargarArchivo("analisis.csv", csvContenido, "text/csv;charset=utf-8;");
    });

    // --- DESCARGA JSON ---
    downloadJsonBtn.addEventListener("click", () => {
      if (!hasResults || !currentAnalysisData) {
        const tr = T[lang];
        alert(tr.alertNoText);
        return;
      }

      const jsonContenido = JSON.stringify(currentAnalysisData, null, 2);
      descargarArchivo("analisis.json", jsonContenido, "application/json;charset=utf-8;");
    });

    function descargarArchivo(nombre, contenido, tipo) {
      const blob = new Blob([contenido], { type: tipo });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = nombre;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Estado inicial correcto: análisis parado, sin resultados => descargas deshabilitadas
    actualizarEstadoAnalisis(false);
    hasResults = false;
    downloadCsvBtn.disabled = true;
    downloadJsonBtn.disabled = true;

    // Aplicar idioma inicial
    applyLang();
  </script>
</body>
</html>
